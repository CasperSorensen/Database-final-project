@using Newtonsoft.Json
@model ObjectOfFieldsForDatabase
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>CheckoutPage</title>
</head>
<body>
    @{

        //error handeling
        //rollback
        //unit price on invoiceline
        //amount 10,2
        //ccv string
        //iban string
        //coMMent textfied
        //fix the relationsin ERD




        var FalseModel = new ObjectOfFieldsForDatabase();
        var invoiceId = AzureDb.Instance.InsertInvoice(Model);
        if (invoiceId == 0)
        {
            <h2>Error occured while making your purchace (invoice generation failed)</h2>
        }
        else
        {



            Dictionary<int, int> Basket = JsonConvert.DeserializeObject<Dictionary<int, int>>(Model.Products);
            List<int> products = new List<int>();

            foreach (var product in Basket)
            {

                int ProductID = product.Key;
                int Quantity = product.Value;
                decimal UnitPrice = AzureDb.Instance.GetUnitPriceForProduct(ProductID);

                //var result = AzureDb.Instance.InsertInvoiceLine(invoiceId, ProductID, Quantity, UnitPrice);
                var result = AzureDb.Instance.InsertInvoiceLine(-1, ProductID, Quantity, UnitPrice);
                if (result == 0)
                {
                    <h2>Error occured while making your purchace (Invoice Line generation failed)</h2>

                }
            }
            <h2>Your Purchase was succesfull</h2>
        }


    }

</body>
</html>
