@using database_final_project.Models;
@using database_final_project.Patterns;
@using Newtonsoft.Json;

@model UserModel
@{
    ViewData["Title"] = "Products";
}

@{
    var loginMsg = TempData["LogginMessage"] != null ? TempData["LogginMessage"].ToString() : "";
    var isLoggedIn = TempData["IsLoggedIn"].ToString();
    TempData.Keep("IsLoggedIn");


    if (isLoggedIn != string.Empty)
    {
        var name = isLoggedIn.ToString().Split(',').ElementAt(0);
        var id = int.Parse(isLoggedIn.ToString().Split(',').ElementAt(1));
        <p> you are logged in as @(isLoggedIn != null ? isLoggedIn.ToString().Split(',').ElementAt(0) : "")</p>

        <div class="container">
            <form name="UserModel" method="POST" action="/Home/Logout">

                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-link">Log Out</button>
                    </div>
                </div>


            </form>
        </div>

        if (TempData["History"] != null)
        {
            var productName = TempData["History"].ToString();

            <h2>Your last Viewed Product is @productName </h2>
        }

        <br />
        <div class="container">
            <form name="UserModel" method="POST" action="/Home/SearchProducts">
                <h2>Search by Product Name or Description</h2>
                <div class="field">
                    <p></p>
                    <div class="control">
                        <input class="input" type="text" placeholder="" name="request" required>
                    </div>
                </div>



                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-link">Search</button>
                    </div>
                </div>

            </form>

            <br />
            <br />

            <h2>Search by Price</h2>
            <form name="UserModel" method="POST" action="/Home/SearchProductsOnPrice">
                <div class="field">
                    <p>Min price:</p>
                    <div class="control">
                        <input class="input" type="number" placeholder="" name="in_min">
                    </div>
                </div>
                <div class="field">
                    <p>Max price:</p>
                    <div class="control">
                        <input class="input" type="number" placeholder="" name="in_max">
                    </div>
                </div>

                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-link">Search Prices</button>
                    </div>
                </div>

            </form>
            <br />
            <form name="UserModel" method="POST" action="/Home/ClearSearchProducts">

                <div class="field is-grouped">
                    <div class="control">
                        <button class="button is-link">Clear Searches</button>
                    </div>
                </div>
            </form>
        </div>
        <br />
        <h1>Products :</h1>
        <br />

        List<Product> products = new List<Product>();

        if (TempData["SearchRequest"] != null)
        {

            products = AzureDb.Instance.SearchProducts(TempData["SearchRequest"].ToString());
        }
        else if (TempData["MinPrice"] != null || TempData["MaxPrice"] != null)
        {

            var minprice = Convert.ToInt32(TempData["MinPrice"]);
            var maxprice = Convert.ToInt32(TempData["MaxPrice"]);

            products = AzureDb.Instance.SearchProductsOnPrice(minprice, maxprice);
        }
        else
        {

            products = AzureDb.Instance.GetProducts();
        }

        foreach (var Product in products)
        {
            <div>

                <h2>@Product.cname</h2>
                <p>Description : @Product.cdescription</p>
                <p> Stock: @Product.nStock units</p>
                <p>Price: @Product.nUnitPrice DKK</p>
                <button>
                    <a href="@Url.Action("AddToBasket", "Home", Product)">Add to basket</a>
                </button>
                <button>
                    <a href="@Url.Action("AddToBasketAsGift", "Home", Product)">Add a gift Wraping for this product</a>
                </button>
                <div class="container">
                    <button>
                        <a href="@Url.Action("ProductDetails","Home",Product)">ProductDetails</a>
                    </button>
                    <button>
                        @{var RateModel = new RateModel();
                            RateModel.ProductId = Product.nProductId;
                        }
                        <a href="@Url.Action("RateProduct","Home",RateModel)">Rate a Product</a>
                    </button>

                </div>
                <br />
                <br />
                <br />
            </div>

        }



    }
    else
    {
        <h2>Acces restricted Please log in <a href="/">here</a></h2>
    }
}

@{

}
